services:
  traefik:
    image: traefik:v3.4
    command:
      - --providers.docker=true
      - --providers.file.filename=/etc/traefik/dynamic.yml
      - --entrypoints.web.address=:80
      - --entrypoints.websecure.address=:443
      - --certificatesresolvers.le.acme.email=${LETSENCRYPT_EMAIL}
      - --certificatesresolvers.le.acme.storage=/letsencrypt/acme.json
      - --certificatesresolvers.le.acme.httpchallenge=true
      - --certificatesresolvers.le.acme.httpchallenge.entrypoint=web
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik/traefik.yml:/traefik.yml:ro
      - ./traefik/dynamic.yml:/etc/traefik/dynamic.yml:ro
      - traefik_letsencrypt:/letsencrypt
    restart: unless-stopped
    networks: [ web ]

  front:
    image: ghcr.io/${GH_OWNER}/${GH_REPO}-front:${IMAGE_TAG}
    depends_on: [ api ]
    environment:
      NITRO_PORT: 3000
      HOST: 0.0.0.0
      # Variables publiques Nuxt si besoin (NUXT_PUBLIC_*)
      NUXT_PUBLIC_API_BASE: https://api.${ROOT_DOMAIN}
    labels:
      - traefik.enable=true
      - traefik.http.routers.front.rule=Host(`${APP_DOMAIN}`)
      - traefik.http.routers.front.entrypoints=websecure
      - traefik.http.routers.front.tls=true
      - traefik.http.routers.front.tls.certresolver=le
      - traefik.http.routers.front.middlewares=security-headers@file
      - traefik.http.services.front.loadbalancer.server.port=3000
    restart: unless-stopped
    networks: [ web, internal ]

  api:
    image: ghcr.io/${GH_OWNER}/${GH_REPO}-api:${IMAGE_TAG}
    depends_on: [ db ]
    environment:
      APP_ENV: prod
      APP_SECRET: ${APP_SECRET}
      DATABASE_URL: ${DATABASE_URL}
      TRUSTED_PROXIES: 10.0.0.0/8,172.16.0.0/12,192.168.0.0/16
      TRUSTED_HOSTS: ^api\.${ROOT_DOMAIN}|${API_DOMAIN}$
    labels:
      - traefik.enable=true
      - traefik.http.routers.api.rule=Host(`${API_DOMAIN}`)
      - traefik.http.routers.api.entrypoints=websecure
      - traefik.http.routers.api.tls=true
      - traefik.http.routers.api.tls.certresolver=le
      - traefik.http.routers.api.middlewares=api-cors@file,security-headers@file
      - traefik.http.services.api.loadbalancer.server.port=8000
    restart: unless-stopped
    networks: [ web, internal ]

  db:
    image: mysql:8.0
    environment:
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
    volumes:
      - db_data:/var/lib/mysql
    command: --default-authentication-plugin=mysql_native_password --performance-schema=OFF
    restart: unless-stopped
    networks: [ internal ]

networks:
  web:
    driver: bridge
  internal:
    internal: true

volumes:
  db_data:
  traefik_letsencrypt:
